@page "/customers/"

@using Model
@using Microsoft.EntityFrameworkCore
@using System.Linq.Dynamic.Core
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage

@inject IDbContextFactory<DatabaseContext> DbFactory
@inject NavigationManager NavigationManager
@inject ProtectedLocalStorage ProtectedLocalStore

<div class="container-fluid">
    <div class="row">
        <div class="col-md-6 col-lg-12 py-2">
            <RadzenCard>
                <RadzenText TextStyle="TextStyle.H4">
                    Clientes
                </RadzenText>
            </RadzenCard>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6 col-lg-12 py-2">
            <RadzenCard>
                <AuthorizeView Policy="Customer.Edit">
                    <span>
                        <RadzenButton Icon="add_circle_outline" Click="AddNewCustomer" Text="Agregar Cliente" />
                    </span>
                </AuthorizeView>
            </RadzenCard>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6 col-lg-12 py-2">
            <RadzenCard>
                <RadzenDataGrid @bind-Settings="@DataGridSettings" Data="@customers" Count="@count" LoadData="@LoadCustomers" TItem="Model.Customer" AllowVirtualization="true" Style="height:650px" FilterMode="FilterMode.Simple" AllowFiltering="true" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" LogicalFilterOperator="LogicalFilterOperator.Or" AllowSorting="true">
                    <Columns>
                        <RadzenDataGridColumn TItem="Model.Customer" Property="Names" Title="Nombre(s)" />
                        <RadzenDataGridColumn TItem="Model.Customer" Property="Lastnames" Title="Apellido(s)" />
                        <RadzenDataGridColumn TItem="Model.Customer" Property="Email" Title="Email" />
                        <RadzenDataGridColumn TItem="Model.Customer" Filterable="false" Sortable="false" Title="Ver" Width="@Constants.SingleMiniButtonPx">
                            <Template Context="customer">
                                <RadzenButton Icon="visibility" ButtonStyle="ButtonStyle.Light" Class="m-1" Size="ButtonSize.Small" Click="@(args => ViewCustomer(customer))" @onclick:stopPropagation="true" />
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            </RadzenCard>
        </div>
    </div>
</div>

@code {

    private IEnumerable<Model.Customer>? customers;

    private DatabaseContext? databaseContext;

    private int count;

    private DataGridSettings? dataGridSettings;

    public DataGridSettings DataGridSettings
    {
        get
        {
            return dataGridSettings!;
        }
        set
        {
            if (dataGridSettings != value)
            {
                dataGridSettings = value;
                InvokeAsync(SaveStateAsync);
            }
        }
    }

    protected override void OnInitialized()
    {
        databaseContext = DbFactory.CreateDbContext();
    }

    private void LoadCustomers(LoadDataArgs loadDataArgs)
    {
        IQueryable<Model.Customer> query = databaseContext!.Customers.Where(c => !c.Deleted).AsQueryable();

        if (!string.IsNullOrEmpty(loadDataArgs.Filter))
        {
            query = query.Where(loadDataArgs.Filter);
        }

        if (!string.IsNullOrEmpty(loadDataArgs.OrderBy))
        {
            query = query.OrderBy(loadDataArgs.OrderBy);
        }

        customers = query.Skip(loadDataArgs.Skip!.Value).Take(loadDataArgs.Top!.Value).ToList();
        count = databaseContext.Customers.Count();
    }

    private void ViewCustomer(Model.Customer customer)
    {
        NavigationManager.NavigateTo("/customer/" + customer!.Id, true);
    }

    private void AddNewCustomer()
    {
        NavigationManager.NavigateTo("/customer/new");
    }

    private async Task LoadStateAsync()
    {
        ProtectedBrowserStorageResult<DataGridSettings> customersDataGridSettings = await ProtectedLocalStore.GetAsync<DataGridSettings>("CustomersDataGridSettings");

        if (customersDataGridSettings.Success)
        {
            dataGridSettings = customersDataGridSettings.Value!;
        }
    }

    private async Task SaveStateAsync()
    {
        await ProtectedLocalStore.SetAsync("CustomersDataGridSettings", dataGridSettings!);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadStateAsync();
            StateHasChanged();
        }
    }
}
